# تقرير إصلاح بيئة التطوير وتوثيق تعارض المنافذ
**التاريخ:** 6 ديسمبر 2025

## 1. المشكلة (The Problem)
واجهنا مشكلة عدم ظهور بيانات "قوالب الدروس" (Lesson Templates) في بيئة التطوير، وتطور الأمر إلى توقف النظام عن العمل مع رسائل خطأ "Network Error" أو "Cannot GET /".

### الأسباب الجذرية:
1.  **بيانات فارغة:** كانت قاعدة البيانات `classroom_dev.db` تحتوي على 68 سجلاً فارغاً ("Untitled")، مما أدى إلى مشاكل في العرض.
2.  **تعارض المنافذ (Port Conflict):**
    *   الواجهة الخلفية (Backend) كانت مبرمجة لتعمل افتراضياً على المنفذ `4201`.
    *   الواجهة الأمامية (Vite Frontend) كانت تعمل أيضاً على المنفذ `4201`.
    *   هذا أدى إلى تصادم، حيث يحاول كلاهما حجز نفس المنفذ.
3.  **إعدادات الوكيل (Proxy Mismatch):**
    *   كان إعداد `vite.config.js` يوجه طلبات الـ API إلى `http://localhost:4200`.
    *   بينما الخادم كان يعمل (أو يحاول العمل) على `4201`.

---

## 2. الحل المطبق (The Solution)
تم اعتماد هيكلية "فصل المنافذ" لبيئة التطوير لضمان استقرار العمل.

### التغييرات التي تمت:
1.  **الواجهة الخلفية (Backend):**
    *   تم تعديل `backend/index.dev.js` ليعمل على المنفذ **4200**.
    *   تم تحديث ملف `.env.development` ليصبح `PORT=4200`.
2.  **الواجهة الأمامية (Frontend):**
    *   بقيت تعمل على المنفذ **4201** (كما هو في `package.json`).
    *   تم تعديل `vite.config.js` ليصبح الهدف (Target) للوكيل هو `http://localhost:4200`.
3.  **البيانات:**
    *   تم إنشاء وتشغيل سكريبت `update_templates.py` لسحب البيانات الحقيقية من ملفات Excel وإصلاح قاعدة البيانات.

### كيفية التشغيل الآن:
```bash
# تشغيل الخادم (Backend) - سيعمل على 4200
npm run dev:backend

# تشغيل الواجهة (Frontend) - ستعمل على 4201
npm run dev:frontend
```

---

## 3. تحذير للمستقبل: بيئة الإنتاج (Production Warning)
**الحالة الحالية:** ملفات إعداد الإنتاج (`.env.production` و `backend/index.js`) مضبوطة حالياً لاستخدام المنفذ **4200** لكل من الواجهة الخلفية والأمامية، مما سيسبب نفس مشكلة التعارض.

### التوصية للمستقبل (عند النشر):
لتجنب هذا في الإنتاج، يفضل استخدام استراتيجية **المنفذ الواحد (Single Port)**:
1.  بناء الواجهة الأمامية (`npm run build`).
2.  جعل خادم Node.js يقدم الملفات الثابتة (Static Files) الناتجة عن البناء.
3.  بذلك يعمل النظام كاملاً على منفذ واحد (4200) ولا حاجة لتشغيل خادم Vite منفصل.

---

## 4. ملفات السكريبت المؤقتة
تم إنشاء الملفات التالية أثناء عملية الإصلاح:
*   `update_templates.py`: (هام) سكريبت إصلاح البيانات. يفضل الاحتفاظ به في مجلد `scripts/`.
*   `test_api.py`, `test_final.py`, `test_api_templates.py`: سكريبتات فحص مؤقتة. يمكن حذفها بأمان.
