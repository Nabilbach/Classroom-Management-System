# نظام دفتر النصوص المتكامل

## نظرة عامة
تم إنشاء نظام دفتر النصوص المتكامل الذي يربط منطقياً وبياناتياً بين تتبع تقدم الدروس والإحصائيات والتقارير. النظام يدعم التوليد التلقائي للسجلات من الحصص المكتملة مع إمكانية التحرير اليدوي الكامل.

## المكونات المطورة

### 1. نماذج البيانات (Backend Models)

#### TextbookEntry Model (`backend/models/textbookEntry.js`)
- نموذج قاعدة البيانات الرئيسي لسجلات دفتر النصوص
- يحتوي على جميع المعلومات الأساسية والتفصيلية للدروس
- دعم JSON fields للمراحل المكتملة (completedStages)
- فهارس محسنة للاستعلامات السريعة
- دعم التوليد التلقائي والتحرير اليدوي

#### واجهات TypeScript (`src/types/textbookTypes.ts`)
```typescript
- TextbookEntry: الواجهة الرئيسية للسجل
- CompletedStage: واجهة مراحل الدرس المكتملة
- TextbookFilter: واجهة فلترة البيانات
- TextbookStats: واجهة الإحصائيات
```

### 2. منطق التوليد التلقائي

#### TextbookGenerationService (`backend/services/textbookGenerationService.js`)
- خدمة شاملة لتوليد سجلات دفتر النصوص تلقائياً
- ربط البيانات مع AdminSchedule للحصول على معلومات المعلم والمادة
- معالجة مراحل الدروس وحساب نسب الإنجاز
- دعم التوليد لفترات محددة أو أقسام معينة
- حماية السجلات المعدلة يدوياً من الكتابة فوقها

#### TextbookScheduler (`backend/services/textbookScheduler.js`)
- مدير المهام المجدولة للتوليد التلقائي
- مهمة يومية (6:00 صباحاً) لتوليد سجلات اليوم السابق
- مهمة أسبوعية (أحد 7:00 صباحاً) لمراجعة الأسبوع السابق
- دعم التوليد الفوري والتحكم في المهام
- استخدام node-cron للجدولة المتقدمة

### 3. واجهات المستخدم (Frontend)

#### TextbookPage (`src/pages/TextbookPageSimple.tsx`)
- واجهة المستخدم الرئيسية لإدارة دفتر النصوص
- عرض الإحصائيات السريعة (إجمالي، تلقائي، يدوي)
- فلترة متقدمة حسب القسم، التاريخ، المعلم
- أدوات التحكم: إضافة، تحرير، حذف، تحديث
- دعم التوليد التلقائي والفوري من الواجهة

#### TextbookEditModal (`src/components/TextbookEditModal.tsx`)
- مودال شامل للتحرير اليدوي للسجلات
- إدارة مراحل الدرس بشكل تفاعلي
- دعم إضافة، تحرير، حذف المراحل
- توليد تلقائي للمحتوى من المراحل
- واجهة سهلة الاستخدام للمعلمين

### 4. خدمات التصدير والطباعة

#### TextbookExportService (`src/services/textbookExportService.ts`)
- تصدير PDF شامل مع دعم الجداول المتقدمة
- تصدير Excel متعدد الأوراق (السجلات، المراحل، الإحصائيات)
- طباعة السجلات المفردة والمتعددة
- تنسيق احترافي للتقارير
- دعم الخط العربي والتخطيط RTL

### 5. مسارات API (Backend Routes)

#### Textbook API (`backend/routes/textbook.js`)
```javascript
// عمليات CRUD الأساسية
GET /api/textbook         // جلب السجلات مع الفلترة
POST /api/textbook        // إنشاء سجل جديد
PUT /api/textbook/:id     // تحديث سجل
DELETE /api/textbook/:id  // حذف سجل

// التوليد التلقائي
POST /api/textbook/generate/period   // توليد لفترة محددة
POST /api/textbook/generate/section  // توليد لقسم محدد
POST /api/textbook/generate/lesson   // توليد من حصة محددة
POST /api/textbook/generate/auto     // التوليد التلقائي العام

// إدارة المجدول
GET /api/textbook/scheduler/status       // حالة المجدول
POST /api/textbook/scheduler/start       // بدء المجدول
POST /api/textbook/scheduler/stop        // إيقاف المجدول
POST /api/textbook/scheduler/run-immediate // تشغيل فوري

// الإحصائيات
GET /api/textbook/stats  // إحصائيات شاملة
```

## الميزات الرئيسية

### 1. التوليد التلقائي الذكي
- ربط تلقائي مع الحصص المكتملة في النظام
- استخراج البيانات من AdminSchedule (المعلم، المادة، القاعة)
- معالجة مراحل الدرس وحساب نسب الإنجاز
- حماية البيانات المعدلة يدوياً

### 2. التحرير اليدوي المتقدم
- إمكانية إنشاء سجلات يدوية كاملة
- تحرير المراحل بشكل تفاعلي
- دعم أنواع مختلفة من المراحل (محتوى، نشاط، تقييم، واجب)
- توليد تلقائي للمحتوى من المراحل

### 3. التقارير والإحصائيات
- إحصائيات شاملة حسب القسم والمعلم
- تقارير مفصلة للمراحل والإنجاز
- عرض بياني للبيانات
- فلترة متقدمة للنتائج

### 4. التصدير والطباعة
- تصدير PDF احترافي مع الجداول
- تصدير Excel متعدد الأوراق
- طباعة السجلات المفردة والمتعددة
- تنسيق مناسب للاستخدام الرسمي

### 5. الجدولة التلقائية
- مهام مجدولة يومية وأسبوعية
- تشغيل تلقائي في الخلفية
- إمكانية التحكم والمراقبة
- تسجيل شامل للعمليات

## التكامل مع النظام الحالي

### 1. ربط مع إدارة التعلم
- استخدام بيانات ScheduledLesson المكتملة
- ربط مع نظام المراحل الموجود
- استفادة من حسابات نسب الإنجاز

### 2. ربط مع الجدول الإداري
- استخراج بيانات المعلم والمادة
- ربط القاعات والأوقات
- تطابق أيام الأسبوع باللغة العربية

### 3. ربط مع إدارة الأقسام
- استخدام بيانات Sections الموجودة
- فلترة حسب الأقسام
- عرض أسماء الأقسام الصحيحة

## طريقة الاستخدام

### للمعلمين:
1. الدخول إلى صفحة "دفتر النصوص" من الشريط الجانبي
2. مراجعة السجلات المولدة تلقائياً
3. تحرير أو إضافة سجلات يدوية حسب الحاجة
4. طباعة أو تصدير التقارير المطلوبة

### للإدارة:
1. مراقبة الإحصائيات العامة
2. تشغيل التوليد التلقائي حسب الحاجة
3. إدارة المجدول الزمني للمهام
4. تصدير التقارير الشاملة

## المتطلبات التقنية

### Backend:
- Node.js مع Express
- Sequelize ORM
- SQLite Database  
- node-cron للجدولة
- jsPDF & xlsx للتصدير

### Frontend:
- React 18 مع TypeScript
- Material-UI v5
- jsPDF & xlsx للتصدير
- React Router للتنقل

## الحالة النهائية
✅ جميع المراحل الخمس مكتملة:
1. ✅ إنشاء نماذج البيانات ومسارات API
2. ✅ تطوير منطق توليد سجلات دفتر النصوص تلقائياً
3. ✅ إنشاء واجهة المستخدم لدفتر النصوص
4. ✅ إضافة إمكانية التحرير اليدوي
5. ✅ إضافة ميزات الطباعة والتصدير

النظام جاهز للاستخدام ويوفر حلاً متكاملاً لإدارة دفتر النصوص بطريقة حديثة وفعالة.