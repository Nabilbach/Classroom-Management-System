const db = require('./backend/models');

async function checkAndFixColumn() {
  try {
    console.log('ğŸ” ÙØ­Øµ Ù‡ÙŠÙƒÙ„ Ø¬Ø¯ÙˆÙ„ StudentAssessments...\n');
    
    await db.sequelize.authenticate();
    console.log('âœ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø¬Ø­\n');
    
    // ÙØ­Øµ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©
    const [columns] = await db.sequelize.query("PRAGMA table_info(StudentAssessments);");
    console.log('ğŸ“‹ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© Ø­Ø§Ù„ÙŠØ§Ù‹:');
    columns.forEach(col => {
      console.log(`   - ${col.name} (${col.type})`);
    });
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¹Ù…ÙˆØ¯
    const hasStudentId = columns.some(col => col.name === 'studentId');
    console.log('\n' + (hasStudentId ? 'âœ…' : 'âŒ') + ' Ø§Ù„Ø¹Ù…ÙˆØ¯ studentId:', hasStudentId ? 'Ù…ÙˆØ¬ÙˆØ¯' : 'ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
    
    // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹ØŒ Ø£Ø¶ÙÙ‡
    if (!hasStudentId) {
      console.log('\nâš™ï¸  Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù…ÙˆØ¯ studentId...');
      try {
        await db.sequelize.query(`
          ALTER TABLE StudentAssessments ADD COLUMN student_id INTEGER;
        `);
        console.log('âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø¨Ù†Ø¬Ø§Ø­');
      } catch (err) {
        // Ù‚Ø¯ ÙŠÙƒÙˆÙ† Ø§Ù„Ø¹Ù…ÙˆØ¯ Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„
        if (err.message.includes('duplicate column name')) {
          console.log('âš ï¸  Ø§Ù„Ø¹Ù…ÙˆØ¯ Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„');
        } else {
          throw err;
        }
      }
    }
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    console.log('\nğŸ“Š ÙØ­Øµ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:');
    const [result] = await db.sequelize.query(`
      SELECT COUNT(*) as total FROM StudentAssessments;
    `);
    console.log(`   Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª: ${result[0].total}`);
    
    console.log('\nâœ… ØªÙ… Ø§Ù„ÙØ­Øµ Ø¨Ù†Ø¬Ø§Ø­!');
    
  } catch (error) {
    console.error('âŒ Ø®Ø·Ø£:', error.message);
  } finally {
    await db.sequelize.close();
  }
}

checkAndFixColumn();
