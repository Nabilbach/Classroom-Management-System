# تحليل مخاطر سكريبتات الإصلاح والفحص والاستعادة 🚨

## مقدمة
هذا التقرير يوضح سكريبتات الصيانة الخطرة الموجودة في النظام ومهامها والمخاطر المرتبطة بها.

## 🔴 السكريبتات عالية الخطورة

### 1. سكريبت إعادة تعيين قاعدة البيانات - `reset_db.js`
**المهمة:**
- حذف جميع الجداول من قاعدة البيانات
- إعادة إنشاء هيكل قاعدة البيانات من الصفر
- مزامنة النماذج مع قاعدة البيانات

**المخاطر الكبرى:** 🚨
```javascript
await db.sequelize.drop(); // حذف جميع البيانات نهائياً!
```
- **فقدان دائم للبيانات**: يحذف جميع بيانات الطلاب والمعلمين والجداول
- **عدم وجود نسخ احتياطية**: لا يأخذ نسخة احتياطية قبل الحذف
- **تشغيل مباشر**: يتم التنفيذ فوراً دون تأكيد
- **لا يمكن التراجع**: العملية غير قابلة للعكس

### 2. سكريبت إصلاح أقسام الطلاب - `repair_student_sections.js`
**المهمة:**
- قراءة ملفات Excel من مجلد "لوائح التلاميذ منفصلة"
- ربط الطلاب بأقسامهم باستخدام رمز المسار
- إنشاء أقسام جديدة تلقائياً إذا لم توجد

**المخاطر المتوسطة:** ⚠️
```javascript
// إنشاء قسم جديد تلقائياً
const created = await Section.create({ 
  id: Date.now().toString(), // معرف غير آمن!
  name: sectionName 
});
```
- **تعديل بيانات إنتاج مباشرة**: يغير sectionId لمئات الطلاب
- **إنشاء أقسام عشوائية**: ينشئ أقسام جديدة بدون تحقق
- **معرفات غير آمنة**: يستخدم Date.now() كمعرف فريد
- **لا يوجد تحقق من صحة البيانات**: يثق بأسماء الملفات

### 3. سكريبت تصحيح أيام الجدول - `fix_schedule_days.js`
**المهمة:**
- تحويل أسماء الأيام من الإنجليزية إلى العربية
- تحديث جدول المواعيد الإدارية

**المخاطر المنخفضة:** 🟡
```javascript
await entry.update({ day: arabicDay }); // تغيير مباشر
```
- **تحديث مباشر للإنتاج**: يغير بيانات الجدول الزمني مباشرة
- **عدم وجود نسخة احتياطية**: لا يحفظ القيم القديمة
- **فرضيات خاطئة**: قد يغير أياماً صحيحة

### 4. سكريبت الترحيل اليدوي - `manual_migration.js`
**المهمة:**
- إضافة عمود sectionId جديد
- ربط الجداول بالأقسام
- حذف الإدخالات اليتيمة
- حذف عمود sectionName القديم

**المخاطر العالية:** 🔴
```javascript
// حذف الإدخالات اليتيمة
await AdministrativeTimetableEntry.destroy({
  where: { sectionId: null }
});

// حذف العمود القديم نهائياً
await queryInterface.removeColumn('administrative_timetable', 'sectionName');
```
- **فقدان دائم للبيانات**: يحذف إدخالات الجدول الزمني اليتيمة
- **تغيير هيكل قاعدة البيانات**: يغير في بنية الجداول
- **عدم قابلية الإرجاع**: حذف الأعمدة غير قابل للتراجع
- **فشل متتالي**: إذا فشل في منتصف العملية يفسد قاعدة البيانات

### 5. سكريبت استعادة الجدول - `restore_schedule.js`
**المهمة:**
- قراءة جدول زمني من ملف CSV
- إنشاء إدخالات جديدة في قاعدة البيانات
- مطابقة أسماء الأقسام مع الموجود

**المخاطر المتوسطة:** ⚠️
```javascript
await AdminScheduleEntry.create({
  id: Date.now().toString() + Math.random().toString().substr(2, 5), // معرف غير آمن
  sectionId: sectionId,
  // ... باقي البيانات
});
```
- **تضارب البيانات**: قد ينشئ جدولاً مكرراً
- **معرفات غير آمنة**: يستخدم تاريخ + عشوائي كمعرف
- **عدم التحقق من التضارب**: لا يفحص الجداول الموجودة
- **ثقة عمياء بملف CSV**: يثق بصحة البيانات الخارجية

## 🟠 سكريبتات الفحص - مخاطر منخفضة لكن مهمة

### سكريبتات الفحص الموجودة:
- `check_data_simple.js` - فحص أساسي للبيانات
- `check_students.js` - فحص بيانات الطلاب
- `check_evaluation_tables.js` - فحص جداول التقييم
- `check_att_schema.js` - فحص مخطط الحضور
- `check_admin_tables.js` - فحص الجداول الإدارية

**المخاطر المحتملة للفحص:**
- **استهلاك الموارد**: قد تستهلك CPU عالي أثناء الفحص
- **قفل قاعدة البيانات**: قد تبطئ العمليات الأخرى
- **معلومات حساسة**: قد تعرض بيانات حساسة في اللوقات

## 🛡️ التوصيات الأمنية

### 1. للسكريبتات عالية الخطورة:
```javascript
// إضافة حماية قبل التنفيذ
const readline = require('readline');

const rl = readline.createInterface({
  input: process.stdin,
  output: process.stdout
});

console.log('⚠️ تحذير: هذا السكريبت سيحذف جميع البيانات!');
rl.question('اكتب "نعم أريد الحذف" للمتابعة: ', (answer) => {
  if (answer !== 'نعم أريد الحذف') {
    console.log('❌ تم إلغاء العملية');
    process.exit(0);
  }
  // متابعة التنفيذ...
});
```

### 2. نظام النسخ الاحتياطية:
```javascript
// أخذ نسخة احتياطية قبل أي تعديل خطر
const backup = require('./services/backup');
await backup.createBackup(`before_${scriptName}_${Date.now()}`);
```

### 3. وضع التطوير المنفصل:
```javascript
// التحقق من البيئة
if (process.env.NODE_ENV === 'production') {
  console.log('❌ لا يمكن تشغيل هذا السكريبت في بيئة الإنتاج');
  process.exit(1);
}
```

### 4. تسجيل العمليات:
```javascript
// تسجيل جميع التغييرات
const auditLog = {
  timestamp: new Date(),
  script: __filename,
  action: 'data_modification',
  affectedRecords: count,
  user: process.env.USER
};
await AuditLog.create(auditLog);
```

## 🚨 خطة الطوارئ

### في حالة تشغيل سكريبت خطر بالخطأ:
1. **إيقاف فوري**: `Ctrl+C` أو قتل العملية
2. **استعادة من النسخة الاحتياطية**: إذا كانت موجودة
3. **فحص الأضرار**: تشغيل سكريبتات الفحص
4. **إعادة البناء**: من آخر نسخة احتياطية سليمة

### خط الدفاع الأول:
```bash
# إنشاء نسخة احتياطية فورية قبل أي سكريبت
cp classroom.db classroom_backup_$(date +%Y%m%d_%H%M%S).db
```

## 📊 إحصائيات المخاطر

| نوع السكريبت | عدد الملفات | مستوى الخطر | تأثير البيانات |
|---------------|-------------|-------------|----------------|
| Reset/Drop | 1 | 🔴 حرج | فقدان كامل |
| Migration | 3 | 🔴 عالي | تغيير هيكلي |
| Repair | 5 | 🟠 متوسط | تعديل بيانات |
| Check | 15+ | 🟡 منخفض | قراءة فقط |

## الخلاصة
هذه السكريبتات ضرورية للصيانة لكنها تشكل مخاطر جسيمة إذا تم تشغيلها بدون حذر. يجب:
- إضافة آليات حماية
- أخذ نسخ احتياطية قبل التشغيل
- اختبار السكريبتات في بيئة تطوير أولاً
- إضافة تسجيل مفصل للعمليات
- وضع ضوابط للوصول لهذه السكريبتات